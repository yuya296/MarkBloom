name: Deploy npm packages

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run publish as dry-run"
        type: boolean
        default: false

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify versions are unpublished
        run: |
          node -e '
          const { execSync } = require("node:child_process");
          const { readFileSync, readdirSync } = require("node:fs");
          const { join } = require("node:path");

          const packagesDir = "packages";
          const prefixes = ["cm6-"];
          const packageDirs = readdirSync(packagesDir, { withFileTypes: true })
            .filter((dirent) => dirent.isDirectory() && prefixes.some((prefix) => dirent.name.startsWith(prefix)))
            .map((dirent) => join(packagesDir, dirent.name));

          const conflicts = [];
          for (const dir of packageDirs) {
            const pkgPath = join(dir, "package.json");
            const pkg = JSON.parse(readFileSync(pkgPath, "utf8"));
            if (!pkg.name || !pkg.version) continue;
            try {
              const published = execSync(`npm view ${pkg.name}@${pkg.version} version`, {
                stdio: ["ignore", "pipe", "pipe"],
              })
                .toString()
                .trim();
              if (published === pkg.version) {
                conflicts.push(`${pkg.name}@${pkg.version}`);
              }
            } catch (err) {
              // Not published yet.
            }
          }

          if (conflicts.length > 0) {
            console.error("Already published versions detected:");
            for (const conflict of conflicts) {
              console.error(`- ${conflict}`);
            }
            process.exit(1);
          }
          console.log("Version check passed.");
          '

      - name: Build packages
        run: pnpm -r --filter @yuya296/* build

      - name: Publish packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            pnpm -r --filter @yuya296/* publish --dry-run
          else
            pnpm -r --filter @yuya296/* publish --no-git-checks
          fi
