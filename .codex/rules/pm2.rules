# ~/.codex/rules/pm2.rules
#
# Policy:
# - Routine process operations: allow
# - Risky/system-level/config-changing commands: prompt

# =========================================================
# Routine process operations (ALLOW)
# =========================================================
prefix_rule(
    pattern = ["pm2", [
        "ls",
        "list",
        "status",
        "show",
        "describe",
        "logs",
        "monit",
        "prettylist",
        "report",
        "ping",

        # process lifecycle (allowed by request)
        "start",
        "restart",
        "reload",
        "stop",
        "delete",
        "scale",
        "reset",
        "flush",
    ]],
    decision = "allow",
    justification = "Routine PM2 process operations are allowed.",
    match = [
        "pm2 list",
        "pm2 status",
        "pm2 logs api --lines 200",
        "pm2 start ecosystem.config.js --only api",
        "pm2 restart api",
        "pm2 reload all",
        "pm2 stop api",
        "pm2 delete api",
        "pm2 scale api 4",
    ],
)

# =========================================================
# Risky / config / system-affecting (PROMPT)
# =========================================================
prefix_rule(
    pattern = ["pm2", [
        # broad impact
        "kill",

        # persistence / boot integration
        "save",
        "resurrect",
        "startup",
        "unstartup",

        # env / config mutation
        "env",
        "set",
        "unset",

        # deployment / hooks / modules
        "deploy",
        "trigger",
        "install",
        "uninstall",
        "module",

        # update-level operations
        "update",
        "deepUpdate",
    ]],
    decision = "prompt",
    justification = "PM2 commands that change persistent config, system startup, environment, or deployment require approval.",
    match = [
        "pm2 kill",
        "pm2 save",
        "pm2 startup",
        "pm2 unstartup",
        "pm2 set pm2:sysmonit true",
        "pm2 unset pm2:sysmonit",
        "pm2 deploy production",
        "pm2 install pm2-logrotate",
    ],
)

